<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>一次 ElasticSearch 宕机事故处理 - Wang Zhiwei</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:image" content><meta property="og:title" content="一次 ElasticSearch 宕机事故处理"><meta property="og:description" content="初次接触使用 ElasticSearch，发现服务进程频繁宕机，排查后发现是堆内存不足导致"><meta property="og:type" content="article"><meta property="og:url" content="https://zhiweio.github.io/posts/es-down-fix/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-07-21T14:40:34+00:00"><meta property="article:modified_time" content="2017-07-21T14:40:34+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="一次 ElasticSearch 宕机事故处理"><meta name=twitter:description content="初次接触使用 ElasticSearch，发现服务进程频繁宕机，排查后发现是堆内存不足导致"><script src=https://zhiweio.github.io/js/feather.min.js></script><link href=https://zhiweio.github.io/css/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://zhiweio.github.io/css/main.css></head><body><div class=content><header><div class=main><a href=https://zhiweio.github.io/>Wang Zhiwei</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>一次 ElasticSearch 宕机事故处理</h1><div class=meta>Posted on Jul 21, 2017</div></div><section class=body><p>早上，当我连上服务器查看昨晚临走时开的数据导入 es 的任务完成度，发现完成到 78% 时挂了</p><p>访问 Kibana 查看 es 状况，red 警报，<code>ps aux | grep elastic</code> 查看 es 服务的进程，没有相关进程</p><p>执行 <code>systemctl status elasticsearch</code>，显示 failed
执行 <code>systemctl start elasticsearch</code> 重新启动 es 服务，启动成功</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>http :9200/_cat/indices
</code></pre></div><p>查看索引，没问题</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>http :9200/userinfo/myspace/_count
</code></pre></div><p>查看某个type的数量，响应很慢，返回error信息，es服务再次挂了
重新启动服务，再次查看，又挂了，这样来回多次，我觉得应该es服务出了问题，但是一头雾水，不知缘故</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>机器配置：</span>
 <span style=color:#ae81ff>24</span><span style=color:#960050;background-color:#1e0010>核</span>
 <span style=color:#ae81ff>48</span><span style=color:#960050;background-color:#1e0010>G内存</span>
 <span style=color:#ae81ff>1.3</span><span style=color:#960050;background-color:#1e0010>T硬盘</span>
</code></pre></div><p>截止昨晚，es 里导入了 8 亿多条数据，占用 305G 左右的存储，没有出错</p><p>Google 了很久，找到下面两篇文章，大概了解问题原因</p><blockquote><p>Elasticsearch配置及优化 <a href=http://news.deepaso.com/search-engine/elasticsearch-config-performance.html>http://news.deepaso.com/search-engine/elasticsearch-config-performance.html</a>
官方文档 - 堆内存：大小和交换 <a href=https://www.elastic.co/guide/cn/elasticsearch/guide/current/heap-sizing.html>https://www.elastic.co/guide/cn/elasticsearch/guide/current/heap-sizing.html</a></p></blockquote><p>Elasticsearch 默认安装后设置的堆内存是 1 GB，这是 es 屡次宕机的原因，我把它设置为机器内存的一半，<code>export ES_HEAP_SIZE=22g</code>，重启 es 服务发现没有生效，可能因为我是通过 Ubuntu 的包管理器 <code>apt</code> 安装的 ElasticSearch，然后用的 Ubuntu 系统工具 <code>systemctl</code> 控制的 es 的服务进程，这种情况下 es 启动时不会从当前 shell 读取 <code>export</code> 设置环境变量</p><p>换种方式：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo vi /usr/share/elasticsearch/bin/elasticsearch
</code></pre></div><p>修改 es 启动脚本文件，增加一行 <code>ES_JAVA_OPTS="-Xms22g -Xmx22g"</code>
这样等于执行 <code>./bin/elasticsearch -Xmx22g -Xms22g</code> 来启动 es 服务进程
具体es的启动配置选项可以看启动脚(<code>/usr/share/elasticsearch/bin/elasticsearch</code>)
改完配置重新启动 es，<code>htop</code> 查看内存情况，很明显内存占用上来了，没改前是 3g+ 的内存占用，现在是 20 多 g
<img src=https://github.com/Zhiwei1996/Zhiwei1996.github.io/raw/master/images/elasticsearch-server-status.png alt>
一切恢复正常 :)</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/%E6%8A%80%E6%9C%AF>技术</a></li></ul></nav></div></article></main><footer><hr><a class=soc href=https://github.com/zhiweio title=GitHub><i data-feather=github></i></a>|⚡️
2021 © Wang Zhiwei | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer><script>feather.replace()</script></div></body></html>